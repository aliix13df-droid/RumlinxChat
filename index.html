<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VyxChat</title>
    <style>
        /* --- CSS TASARIMI (WhatsApp Tarzı) --- */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #d1d7db; height: 100vh; display: flex; justify-content: center; }
        
        /* Ana Uygulama Kutusu */
        #app { width: 100%; max-width: 480px; background: #efe7dd; display: flex; flex-direction: column; height: 100%; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Başlık Alanı */
        header { background-color: #008069; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
        header h1 { margin: 0; font-size: 20px; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .user-info img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); }

        /* Giriş Ekranı */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #fff; text-align: center; padding: 20px; }
        #login-screen h2 { color: #008069; margin-bottom: 10px; }
        .btn-login { background-color: #008069; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 24px; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-login:active { transform: scale(0.98); }

        /* Mesaj Alanı */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: none; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-repeat: repeat; background-size: 400px; }
        
        /* Mesaj Baloncukları */
        .message { max-width: 75%; padding: 8px 10px; border-radius: 8px; font-size: 14.2px; line-height: 19px; position: relative; word-wrap: break-word; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); display: flex; flex-direction: column; }
        
        .message.sent { align-self: flex-end; background-color: #dcf8c6; border-radius: 8px 0 8px 8px; }
        .message.received { align-self: flex-start; background-color: #fff; border-radius: 0 8px 8px 8px; }
        
        .msg-sender { font-size: 11px; font-weight: bold; color: #e542a3; margin-bottom: 2px; }
        .sent .msg-sender { display: none; } /* Kendi mesajımızda ismimiz yazmasın */
        
        .msg-time { font-size: 10px; color: #999; align-self: flex-end; margin-top: 4px; margin-left: 10px; }
        .sent .msg-time { color: #7fad75; }

        /* Alt Kısım (Input) */
        .input-area { background: #f0f0f0; padding: 10px; display: none; align-items: center; gap: 10px; }
        .input-area input { flex: 1; padding: 12px 15px; border-radius: 24px; border: none; outline: none; font-size: 15px; }
        .btn-send { background: #008069; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="app">
    <header>
        <h1>VyxChat</h1>
        <div class="user-info" id="userInfo" style="display:none;">
            <span id="userName"></span>
            <img id="userPic" src="" alt="Profil">
            <button onclick="logout()" style="background:none; border:none; color:white; font-size:12px; cursor:pointer;">(Çıkış)</button>
        </div>
    </header>

    <div id="login-screen">
        <h2>Hoş Geldiniz</h2>
        <p>Devam etmek için giriş yapın.</p>
        <button class="btn-login" onclick="login()">Google ile Giriş Yap</button>
    </div>

    <div id="chat-container">
        </div>

    <div class="input-area" id="inputArea">
        <input type="text" id="msgInput" placeholder="Bir mesaj yazın..." onkeypress="handleEnter(event)">
        <button class="btn-send" onclick="sendMessage()">➤</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // SENİN CONFIG BİLGİLERİN
    const firebaseConfig = {
        apiKey: "AIzaSyDo3zkxE-4_V6qs6FQ21_x523gul5EaP7U",
        authDomain: "rumlinx.firebaseapp.com",
        projectId: "rumlinx",
        storageBucket: "rumlinx.firebasestorage.app",
        messagingSenderId: "107571707229",
        appId: "1:107571707229:web:1be9f876588c4197b8bcb4"
    };

    // Uygulamayı Başlat
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;

    // --- GİRİŞ İŞLEMLERİ ---
    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // Oturum Durumunu Dinle
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            // Giriş yapıldıysa
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('inputArea').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'flex';
            
            document.getElementById('userName').innerText = user.displayName.split(' ')[0]; // Sadece ilk ismi al
            document.getElementById('userPic').src = user.photoURL;

            loadMessages(); // Mesajları getir
        } else {
            // Çıkış yapıldıysa
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('inputArea').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
        }
    });

    // --- MESAJ GÖNDERME ---
    window.sendMessage = async () => {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();

        if (text && currentUser) {
            try {
                await addDoc(collection(db, "chats"), {
                    text: text,
                    uid: currentUser.uid,
                    sender: currentUser.displayName,
                    photo: currentUser.photoURL,
                    createdAt: serverTimestamp()
                });
                input.value = ""; // Kutuyu temizle
            } catch (e) {
                console.error("Mesaj gitmedi: ", e);
                alert("Mesaj gönderilemedi. Kuralları (Rules) kontrol et!");
            }
        }
    };

    window.handleEnter = (e) => {
        if (e.key === 'Enter') window.sendMessage();
    };

    // --- MESAJLARI OKUMA ---
    function loadMessages() {
        const q = query(collection(db, "chats"), orderBy("createdAt", "asc"));
        
        onSnapshot(q, (snapshot) => {
            const chatBox = document.getElementById('chat-container');
            chatBox.innerHTML = ""; // Önce temizle
            
            snapshot.forEach((doc) => {
                const msg = doc.data();
                const isMe = msg.uid === currentUser.uid;
                
                // Saat formatı (Timestamp null gelirse şimdiki saati göster)
                let time = "Az önce";
                if(msg.createdAt) {
                    const date = msg.createdAt.toDate();
                    time = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0');
                }

                const msgDiv = `
                    <div class="message ${isMe ? 'sent' : 'received'}">
                        <div class="msg-sender">${msg.sender}</div>
                        ${msg.text}
                        <div class="msg-time">${time}</div>
                    </div>
                `;
                chatBox.innerHTML += msgDiv;
            });

            // En alta kaydır
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
</script>

</body>
</html>
